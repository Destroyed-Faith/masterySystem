<form class="{{cssClass}}" autocomplete="off">
  
  <!-- Header -->
  <header class="sheet-header">
    <img class="profile-img {{#if editable}}{{else}}locked{{/if}}" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" alt="{{actor.name}}" />
    
    <div class="header-info">
      <div class="mastery-rank-box">
        <label>Mastery Rank</label>
        {{#if editable}}
          <input type="number" name="system.mastery.rank" value="{{default system.mastery.rank 2}}" min="1" max="20" data-dtype="Number" />
        {{else}}
          <span class="rank-value">{{default system.mastery.rank 2}}</span>
        {{/if}}
      </div>
      
      <div class="character-name-box">
        {{#if editable}}
          <input name="name" type="text" value="{{actor.name}}" placeholder="Character Name" />
        {{else}}
          <h1>{{actor.name}}</h1>
        {{/if}}
      </div>
    </div>
    
    {{#if owner}}
      <button type="button" class="edit-mode-toggle" title="Toggle Edit Mode">
        <i class="fas fa-edit"></i> {{#if editable}}Lock{{else}}Edit{{/if}}
      </button>
    {{/if}}
  </header>

  <!-- Tabs Navigation (Right Side Bookmarks) -->
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="attributes"><i class="fas fa-fist-raised"></i> Attributes</a>
    <a class="item" data-tab="skills"><i class="fas fa-cogs"></i> Skills</a>
    <a class="item" data-tab="powers"><i class="fas fa-magic"></i> Powers</a>
    <a class="item" data-tab="magic"><i class="fas fa-hat-wizard"></i> Magic</a>
    <a class="item" data-tab="equipment"><i class="fas fa-shield-alt"></i> Equipment</a>
    <a class="item" data-tab="biography"><i class="fas fa-scroll"></i> Bio</a>
  </nav>

  <!-- Sheet Body -->
  <section class="sheet-body">
    
    <!-- ATTRIBUTES TAB -->
    <div class="tab attributes" data-group="primary" data-tab="attributes">
      
      <!-- Attributes Grid Section -->
      <div class="attributes-grid-section">
        <h3><i class="fas fa-fist-raised"></i> Character Attributes</h3>
        
        <!-- Row 1: Physical + Mental Attributes -->
        <div class="attributes-grid">
          
          <!-- Might -->
          {{#with system.attributes.might}}
            <div class="attribute-card" data-attribute="might">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-dumbbell"></i> Might</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <!-- Stones Display -->
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              <!-- Controls -->
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="might" data-adjustment="-1" title="Decrease">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.might.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="might" data-adjustment="1" title="Increase">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{else}}
                <div class="attribute-value-static">{{default value 0}}</div>
              {{/if}}
              
              <!-- Roll Button -->
              <button type="button" class="attribute-roll" data-attribute="might" title="Roll Might">
                <i class="fas fa-dice-d20"></i> Roll Might
              </button>
            </div>
          {{/with}}
          
          <!-- Agility -->
          {{#with system.attributes.agility}}
            <div class="attribute-card" data-attribute="agility">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-running"></i> Agility</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="agility" data-adjustment="-1">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.agility.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="agility" data-adjustment="1">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{/if}}
              
              <button type="button" class="attribute-roll" data-attribute="agility">
                <i class="fas fa-dice-d20"></i> Roll Agility
              </button>
            </div>
          {{/with}}
          
          <!-- Vitality -->
          {{#with system.attributes.vitality}}
            <div class="attribute-card" data-attribute="vitality">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-heart"></i> Vitality</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="vitality" data-adjustment="-1">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.vitality.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="vitality" data-adjustment="1">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{/if}}
              
              <button type="button" class="attribute-roll" data-attribute="vitality">
                <i class="fas fa-dice-d20"></i> Roll Vitality
              </button>
            </div>
          {{/with}}
          
          <!-- Wits -->
          {{#with system.attributes.wits}}
            <div class="attribute-card" data-attribute="wits">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-brain"></i> Wits</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="wits" data-adjustment="-1">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.wits.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="wits" data-adjustment="1">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{/if}}
              
              <button type="button" class="attribute-roll" data-attribute="wits">
                <i class="fas fa-dice-d20"></i> Roll Wits
              </button>
            </div>
          {{/with}}
          
        </div>
        
        <!-- Row 2: Mental/Social Attributes -->
        <div class="attributes-grid">
          
          <!-- Intellect -->
          {{#with system.attributes.intellect}}
            <div class="attribute-card" data-attribute="intellect">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-book"></i> Intellect</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="intellect" data-adjustment="-1">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.intellect.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="intellect" data-adjustment="1">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{/if}}
              
              <button type="button" class="attribute-roll" data-attribute="intellect">
                <i class="fas fa-dice-d20"></i> Roll Intellect
              </button>
            </div>
          {{/with}}
          
          <!-- Resolve -->
          {{#with system.attributes.resolve}}
            <div class="attribute-card" data-attribute="resolve">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-mountain"></i> Resolve</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="resolve" data-adjustment="-1">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.resolve.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="resolve" data-adjustment="1">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{/if}}
              
              <button type="button" class="attribute-roll" data-attribute="resolve">
                <i class="fas fa-dice-d20"></i> Roll Resolve
              </button>
            </div>
          {{/with}}
          
          <!-- Influence -->
          {{#with system.attributes.influence}}
            <div class="attribute-card" data-attribute="influence">
              <div class="attribute-card-header">
                <h4 class="attribute-name"><i class="fas fa-users"></i> Influence</h4>
                <div class="attribute-value">{{default value 0}}</div>
              </div>
              
              <div class="attribute-stones">
                <div class="stones-container">
                  {{#times (calculateStones value)}}
                    <span class="stone filled">⬤</span>
                  {{/times}}
                  {{#times (subtract 5 (calculateStones value))}}
                    <span class="stone empty">○</span>
                  {{/times}}
                </div>
                <div class="stones-count">{{calculateStones value}} / 5 Stones</div>
              </div>
              
              {{#if ../../editable}}
                <div class="attribute-controls">
                  <button type="button" class="attribute-adjust" data-attribute="influence" data-adjustment="-1">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" name="system.attributes.influence.value" value="{{default value 0}}" min="0" max="40" data-dtype="Number" />
                  <button type="button" class="attribute-adjust" data-attribute="influence" data-adjustment="1">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              {{/if}}
              
              <button type="button" class="attribute-roll" data-attribute="influence">
                <i class="fas fa-dice-d20"></i> Roll Influence
              </button>
            </div>
          {{/with}}
          
        </div>
        
        <!-- Total Stones Summary -->
        <div class="stones-summary">
          <div class="stones-summary-content">
            <div class="stones-summary-item">
              <h4><i class="fas fa-gem"></i> Total Stones</h4>
              <div class="stones-total">
                <span class="current">{{default resources.stones.current 0}}</span> / 
                <span class="maximum">{{default resources.stones.maximum 0}}</span>
              </div>
            </div>
            <div class="stones-summary-item">
              <h4><i class="fas fa-sync-alt"></i> Regeneration</h4>
              <div class="stones-regen">
                {{default resources.stones.regeneration 2}} per round
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Combat Stats Section -->
      <div class="combat-stats-section">
        <h3><i class="fas fa-shield-alt"></i> Combat Statistics</h3>
        
        <div class="combat-stats-grid">
          <!-- Evade -->
          <div class="combat-stat-card">
            <div class="stat-icon evade-icon"><i class="fas fa-wind"></i></div>
            <div class="stat-content">
              <label>Evade</label>
              <div class="stat-value">{{default system.combat.evadeTotal 10}}</div>
              <div class="stat-formula">Agi + Def.Combat + (MR×2)</div>
            </div>
          </div>
          
          <!-- Armor -->
          <div class="combat-stat-card">
            <div class="stat-icon armor-icon"><i class="fas fa-shield-alt"></i></div>
            <div class="stat-content">
              <label>Armor</label>
              <div class="stat-value">{{default system.combat.armorTotal 0}}</div>
              <div class="stat-formula">Base + Shield + Passives</div>
            </div>
          </div>
          
          <!-- Speed -->
          <div class="combat-stat-card">
            <div class="stat-icon speed-icon"><i class="fas fa-running"></i></div>
            <div class="stat-content">
              <label>Speed</label>
              <div class="stat-value">{{default system.combat.speed 6}}m</div>
              <div class="stat-formula">Base Movement</div>
            </div>
          </div>
          
          <!-- Initiative Bonus -->
          <div class="combat-stat-card">
            <div class="stat-icon initiative-icon"><i class="fas fa-bolt"></i></div>
            <div class="stat-content">
              <label>Initiative</label>
              <div class="stat-value">+{{default system.combat.initiativeBonus 0}}</div>
              <div class="stat-formula">Combat Reflexes</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Saving Throws Section -->
      <div class="saving-throws-section">
        <h3><i class="fas fa-dice-d20"></i> Saving Throws</h3>
        
        <div class="saving-throws-grid-three">
          <!-- Body Save: Max(Might, Agility) k Mastery + Vitality -->
          <div class="saving-throw-card">
            <h4 class="save-title">
              <i class="fas fa-dumbbell"></i> Body Save
            </h4>
            <div class="save-pool">
              {{#if (gt system.attributes.might.value system.attributes.agility.value)}}
                {{system.attributes.might.value}}d8
              {{else}}
                {{system.attributes.agility.value}}d8
              {{/if}}
              k {{default system.mastery.rank 2}} + {{default system.attributes.vitality.value 2}}
            </div>
            <button type="button" class="save-roll-btn" data-save-type="body" title="Roll Body Save">
              <i class="fas fa-dice-d20"></i> Roll Save
            </button>
          </div>
          
          <!-- Mind Save: Max(Intellect, Wits) k Mastery + Vitality -->
          <div class="saving-throw-card">
            <h4 class="save-title">
              <i class="fas fa-brain"></i> Mind Save
            </h4>
            <div class="save-pool">
              {{#if (gt system.attributes.intellect.value system.attributes.wits.value)}}
                {{system.attributes.intellect.value}}d8
              {{else}}
                {{system.attributes.wits.value}}d8
              {{/if}}
              k {{default system.mastery.rank 2}} + {{default system.attributes.vitality.value 2}}
            </div>
            <button type="button" class="save-roll-btn" data-save-type="mind" title="Roll Mind Save">
              <i class="fas fa-dice-d20"></i> Roll Save
            </button>
          </div>
          
          <!-- Spirit Save: Max(Resolve, Influence) k Mastery + Vitality -->
          <div class="saving-throw-card">
            <h4 class="save-title">
              <i class="fas fa-hands-praying"></i> Spirit Save
            </h4>
            <div class="save-pool">
              {{#if (gt system.attributes.resolve.value system.attributes.influence.value)}}
                {{system.attributes.resolve.value}}d8
              {{else}}
                {{system.attributes.influence.value}}d8
              {{/if}}
              k {{default system.mastery.rank 2}} + {{default system.attributes.vitality.value 2}}
            </div>
            <button type="button" class="save-roll-btn" data-save-type="spirit" title="Roll Spirit Save">
              <i class="fas fa-dice-d20"></i> Roll Save
            </button>
          </div>
        </div>
        
        <div class="save-explanation">
          <p><strong>Body:</strong> Resist poison, disease, exhaustion</p>
          <p><strong>Mind:</strong> Resist fear, charm, confusion</p>
          <p><strong>Spirit:</strong> Resist curses, divine effects</p>
        </div>
      </div>
      
    </div>
    
    <!-- SKILLS TAB -->
    <div class="tab skills" data-group="primary" data-tab="skills">
      
      <div class="skills-overview">
        <h3><i class="fas fa-cogs"></i> Skills</h3>
        <p class="skills-description">
          Skills provide <strong>flat bonuses</strong> added after your roll. Max: <strong>4 × Mastery Rank</strong>
        </p>
      </div>
      
      {{#each skills}}
        {{#if @first}}
          <div class="skill-category-compact">
            <h4 class="category-header-compact">
              {{#if (eq this.category "Physical")}}<i class="fas fa-running"></i>{{/if}}
              {{#if (eq this.category "Knowledge & Craft")}}<i class="fas fa-book"></i>{{/if}}
              {{#if (eq this.category "Social")}}<i class="fas fa-comments"></i>{{/if}}
              {{#if (eq this.category "Survival")}}<i class="fas fa-tree"></i>{{/if}}
              {{#if (eq this.category "Martial")}}<i class="fas fa-sword"></i>{{/if}}
              {{this.category}}
            </h4>
            <div class="skills-list-compact">
        {{else}}
          {{#unless (eq this.category @root.skills.[subtract @index 1].category)}}
            </div></div>
            <div class="skill-category-compact">
              <h4 class="category-header-compact">
                {{#if (eq this.category "Physical")}}<i class="fas fa-running"></i>{{/if}}
                {{#if (eq this.category "Knowledge & Craft")}}<i class="fas fa-book"></i>{{/if}}
                {{#if (eq this.category "Social")}}<i class="fas fa-comments"></i>{{/if}}
                {{#if (eq this.category "Survival")}}<i class="fas fa-tree"></i>{{/if}}
                {{#if (eq this.category "Martial")}}<i class="fas fa-sword"></i>{{/if}}
                {{this.category}}
              </h4>
              <div class="skills-list-compact">
          {{/unless}}
        {{/if}}
        
        <div class="skill-row-compact">
          <span class="skill-name-compact">{{this.name}}</span>
          <div class="skill-attrs-compact">
            {{#each this.attributes}}
              <span class="attr-badge">{{capitalize this}}</span>
            {{/each}}
          </div>
          {{#if ../../editable}}
            <input type="number" name="system.skills.{{this.key}}" value="{{default this.value 0}}" min="0" max="32" class="skill-value-compact" data-dtype="Number" />
          {{else}}
            <span class="skill-value-compact">{{default this.value 0}}</span>
          {{/if}}
          <button type="button" class="skill-roll-compact" data-skill="{{this.key}}" title="Roll {{this.name}}">
            <i class="fas fa-dice-d20"></i>
          </button>
        </div>
        
        {{#if @last}}
            </div>
          </div>
        {{/if}}
      {{/each}}
      
    </div>
    
    <!-- POWERS TAB -->
    <div class="tab powers" data-group="primary" data-tab="powers">
      
      <div class="powers-overview">
        <h3><i class="fas fa-magic"></i> Mastery Powers</h3>
        <button type="button" class="add-power-btn" title="Add New Power">
          <i class="fas fa-plus"></i> Add Power
        </button>
      </div>
      
      <!-- Powers List -->
      <div class="powers-list-section">
        {{#if items.powers}}
          {{#each items.powers}}
            <div class="power-card" data-item-id="{{this.id}}">
              <div class="power-header">
                <h4 class="power-name">{{this.name}}</h4>
                <div class="power-controls">
                  <button type="button" class="item-edit" title="Edit"><i class="fas fa-edit"></i></button>
                  <button type="button" class="item-delete" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
              </div>
              <div class="power-details">
                <span class="power-tree">{{default this.system.tree "No Tree"}}</span>
                <span class="power-level">Level {{default this.system.level 1}}</span>
                <span class="power-type">{{default this.system.powerType "Active"}}</span>
              </div>
              <div class="power-description">{{this.system.description}}</div>
              {{#if this.system.equipped}}
                <button type="button" class="power-use-btn" data-power-id="{{this.id}}">
                  <i class="fas fa-bolt"></i> Use Power
                </button>
              {{/if}}
            </div>
          {{/each}}
        {{else}}
          <p class="empty-message">No powers yet. Click "Add Power" to start.</p>
        {{/if}}
      </div>
      
    </div>
    
    <!-- MAGIC TAB -->
    <div class="tab magic" data-group="primary" data-tab="magic">
      
      <div class="magic-overview">
        <h3><i class="fas fa-hat-wizard"></i> Spell Schools</h3>
        <button type="button" class="add-spell-btn" title="Add New Spell">
          <i class="fas fa-plus"></i> Add Spell
        </button>
      </div>
      
      <!-- Spells List -->
      <div class="spells-list-section">
        {{#if items.spells}}
          {{#each items.spells}}
            <div class="spell-card" data-item-id="{{this.id}}">
              <div class="spell-header">
                <h4 class="spell-name">{{this.name}}</h4>
                <div class="spell-controls">
                  <button type="button" class="item-edit" title="Edit"><i class="fas fa-edit"></i></button>
                  <button type="button" class="item-delete" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
              </div>
              <div class="spell-details">
                <span class="spell-school">{{default this.system.school "No School"}}</span>
                <span class="spell-level">Level {{default this.system.level 1}}</span>
                <span class="spell-type">{{default this.system.spellType "Active"}}</span>
              </div>
              <div class="spell-description">{{this.system.description}}</div>
              {{#if this.system.prepared}}
                <button type="button" class="spell-cast-btn" data-spell-id="{{this.id}}">
                  <i class="fas fa-magic"></i> Cast Spell
                </button>
              {{/if}}
            </div>
          {{/each}}
        {{else}}
          <p class="empty-message">No spells yet. Click "Add Spell" to start.</p>
        {{/else}}
      </div>
      
    </div>
    
    <!-- EQUIPMENT TAB -->
    <div class="tab equipment" data-group="primary" data-tab="equipment">
      <p style="padding: 20px; text-align: center; color: #666;">Equipment tab - Weapons, Armor, Artifacts</p>
    </div>
    
    <!-- BIOGRAPHY TAB -->
    <div class="tab biography" data-group="primary" data-tab="biography">
      <p style="padding: 20px; text-align: center; color: #666;">Biography tab - Background, Notes</p>
    </div>
    
  </section>
</form>
