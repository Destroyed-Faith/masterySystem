<form class="{{cssClass}} flexcol" autocomplete="off">
  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <div class="header-left">
      <img class="profile-img {{#unless editMode}}locked{{/unless}}" 
           src="{{actor.img}}" 
           {{#if editMode}}data-edit="img"{{/if}}
           title="{{actor.name}}" 
           height="100" 
           width="100"/>
      <div class="header-fields">
        <h1 class="charname">
          {{#if editMode}}
            <input name="name" type="text" value="{{actor.name}}" placeholder="Character Name"/>
          {{else}}
            <span>{{actor.name}}</span>
          {{/if}}
        </h1>
        <div class="mastery-rank-display">
          <label>Mastery Rank:</label>
          {{#if editMode}}
            <input type="number" name="system.mastery.rank" value="{{system.mastery.rank}}" data-dtype="Number" min="1" max="8"/>
          {{else}}
            <span class="value">M{{system.mastery.rank}}</span>
          {{/if}}
        </div>
      </div>
    </div>
    <div class="header-right">
      <button type="button" class="edit-mode-toggle" title="{{#if editMode}}Lock Editing{{else}}Edit Header{{/if}}">
        <i class="fas {{#if editMode}}fa-lock{{else}}fa-edit{{/if}}"></i>
      </button>
    </div>
  </header>

  {{!-- Sheet Body --}}
  <section class="sheet-body">
      
      {{!-- Attributes Tab --}}
      <div class="tab attributes" data-group="primary" data-tab="attributes">
        
        {{!-- Top Section: Saving Throws and Evade --}}
        <div class="attributes-top-section">
          {{!-- First Attribute (Might) with Saving Throws beside it --}}
          <div class="top-row">
            <div class="attribute-row">
              <label class="attribute-name-vertical">might</label>
              <div class="attribute-circle-wrapper">
                <div class="attribute-circle" data-attribute="might">
                  <div class="circle-center">
                    <input type="number" 
                           name="system.attributes.might.value" 
                           value="{{system.attributes.might.value}}" 
                           data-dtype="Number" 
                           min="0"
                           class="attribute-value-input"/>
                    <button type="button" class="attribute-roll" data-attribute="might" title="Roll might">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  </div>
                  <div class="stones-ring">
                    {{#each (array 8 16 24 32 40 48 56 64 72 80) as |threshold index|}}
                    <div class="stone-segment stone-segment-{{index}} {{#if (gte system.attributes.might.value threshold)}}filled{{/if}}" 
                         data-threshold="{{threshold}}"
                         title="{{threshold}}"
                         style="--a: {{multiply index 36}}deg">
                      {{threshold}}
                    </div>
                    {{/each}}
                  </div>
                </div>
              </div>
            </div>
            
            {{!-- Saving Throws --}}
            <div class="saving-throws-container-top">
              <div class="saving-throws-grid-top">
                <div class="saving-throw-item" data-save="body">
                  <label>BODY</label>
                  <div class="saving-throw-value-group">
                    <span class="saving-throw-value">{{derivedValues.savingThrows.body}}</span>
                    <button type="button" class="saving-throw-roll" data-save="body" title="Roll BODY Saving Throw">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  </div>
                </div>
                <div class="saving-throw-item" data-save="will">
                  <label>WILL</label>
                  <div class="saving-throw-value-group">
                    <span class="saving-throw-value">{{derivedValues.savingThrows.will}}</span>
                    <button type="button" class="saving-throw-roll" data-save="will" title="Roll WILL Saving Throw">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  </div>
                </div>
                <div class="saving-throw-item" data-save="mind">
                  <label>MIND</label>
                  <div class="saving-throw-value-group">
                    <span class="saving-throw-value">{{derivedValues.savingThrows.mind}}</span>
                    <button type="button" class="saving-throw-roll" data-save="mind" title="Roll MIND Saving Throw">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              {{!-- Evade and Initiative --}}
              <div class="combat-values-container">
                <div class="evade-value-container">
                  <label>Evade:</label>
                  <input type="number" name="system.combat.evade" value="{{system.combat.evade}}" data-dtype="Number"/>
                </div>
                <div class="initiative-value-container">
                  <label>Initiative:</label>
                  <input type="number" name="system.combat.initiative" value="{{system.combat.initiative}}" data-dtype="Number"/>
                </div>
              </div>
            </div>
          </div>
        </div>

        {{!-- Remaining Attributes in Circles --}}
        <div class="attributes-circles-container">
          {{#each system.attributes as |attr key|}}
          {{#unless (eq key "might")}}
          <div class="attribute-row">
            <label class="attribute-name-vertical">{{key}}</label>
            <div class="attribute-circle-wrapper">
              <div class="attribute-circle" data-attribute="{{key}}">
                <div class="circle-center">
                  <input type="number" 
                         name="system.attributes.{{key}}.value" 
                         value="{{attr.value}}" 
                         data-dtype="Number" 
                         min="0"
                         class="attribute-value-input"/>
                  <button type="button" class="attribute-roll" data-attribute="{{key}}" title="Roll {{key}}">
                    <i class="fas fa-dice-d20"></i>
                  </button>
                </div>
                <div class="stones-ring">
                  {{#each (array 8 16 24 32 40 48 56 64 72 80) as |threshold index|}}
                  <div class="stone-segment stone-segment-{{index}} {{#if (gte attr.value threshold)}}filled{{/if}}" 
                       data-threshold="{{threshold}}"
                       title="{{threshold}}"
                       style="--a: {{multiply index 36}}deg">
                    {{threshold}}
                  </div>
                  {{/each}}
                </div>
              </div>
            </div>
          </div>
          {{/unless}}
          {{/each}}
        </div>


        {{!-- Armor and Shield Panel --}}
        <div class="armor-shield-panel">
          <div class="armor-shield-item">
            <label>Armor:</label>
            <div class="armor-shield-content">
              <input type="number" name="system.combat.armor" value="{{system.combat.armor}}" data-dtype="Number" class="armor-value"/>
              <input type="text" name="system.combat.armorName" value="{{system.combat.armorName}}" placeholder="Armor Name" class="armor-name"/>
            </div>
          </div>
          <div class="armor-shield-item">
            <label>Shield:</label>
            <div class="armor-shield-content">
              <input type="number" name="system.combat.shield" value="{{system.combat.shield}}" data-dtype="Number" class="armor-value"/>
              <input type="text" name="system.combat.shieldName" value="{{system.combat.shieldName}}" placeholder="Shield Name" class="armor-name"/>
            </div>
          </div>
        </div>

        {{!-- Faith Fractures Circle --}}
        <div class="faith-fractures-container">
          <h3>Faith Fractures</h3>
          <div class="faith-fractures-circle-wrapper">
            <div class="faith-fractures-circle">
              <div class="fractures-center">
                <label class="fractures-label">Fractures</label>
                <input type="number" 
                       name="system.faithFractures.current" 
                       value="{{system.faithFractures.current}}" 
                       data-dtype="Number" 
                       min="0"
                       class="fractures-value-input"/>
              </div>
              <div class="fractures-ring">
                {{#each (array 1 2 3 4 5 6 7 8 9 10) as |fracture index|}}
                <div class="fracture-segment fracture-segment-{{index}} {{#if (gte system.faithFractures.current fracture)}}filled{{/if}}" 
                     data-fracture="{{fracture}}"
                     title="{{fracture}}"
                     style="--a: {{multiply index 36}}deg">
                  {{fracture}}
                </div>
                {{/each}}
              </div>
            </div>
            <div class="fractures-notes">
              <label>Notes:</label>
              <textarea name="system.notes.faithFractures" placeholder="Faith Fracture notes and disadvantages...">{{system.notes.faithFractures}}</textarea>
            </div>
          </div>
        </div>

        {{!-- Bottom Stats Panel --}}
        <div class="bottom-stats-panel">
          <div class="stat-group">
            <label>Health Levels:</label>
            <div class="health-bars-compact">
              {{#each system.health.bars as |bar index|}}
              <div class="health-bar-compact {{#if (eq ../system.health.currentBar index)}}active{{/if}}">
                <span class="bar-name">{{bar.name}}</span>
                <span class="bar-hp">{{bar.current}} / {{bar.max}}</span>
                <span class="bar-penalty">({{bar.penalty}})</span>
              </div>
              {{/each}}
            </div>
          </div>
          <div class="stat-group">
            <label>Stress:</label>
            <div class="stress-display-compact">
              <input type="number" name="system.stress.current" value="{{system.stress.current}}" data-dtype="Number"/> / {{system.stress.maximum}}
              <div class="button-group-compact">
                <button type="button" class="stress-adjust" data-adjustment="-5">-5</button>
                <button type="button" class="stress-adjust" data-adjustment="-1">-1</button>
                <button type="button" class="stress-adjust" data-adjustment="1">+1</button>
                <button type="button" class="stress-adjust" data-adjustment="5">+5</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {{!-- Skills Tab --}}
      <div class="tab skills" data-group="primary" data-tab="skills">
        <div class="skills-header">
          <h3>Skills</h3>
          <button type="button" class="skill-add"><i class="fas fa-plus"></i> Add Skill</button>
        </div>
        <ol class="skills-list">
          {{#each skills as |skill|}}
          <li class="skill">
            <div class="skill-name">{{skill.label}}</div>
            <input type="number" name="system.skills.{{skill.name}}" value="{{skill.value}}" data-dtype="Number" min="0"/>
            <button type="button" class="skill-roll" data-skill="{{skill.name}}">
              <i class="fas fa-dice-d20"></i>
            </button>
            <button type="button" class="skill-delete" data-skill="{{skill.name}}">
              <i class="fas fa-trash"></i>
            </button>
          </li>
          {{/each}}
        </ol>
      </div>

      {{!-- Powers Tab --}}
      <div class="tab powers" data-group="primary" data-tab="powers">
        <div class="powers-header">
          <h3>Powers & Mastery Trees</h3>
          <button type="button" class="item-create" data-type="special"><i class="fas fa-plus"></i> Add Power</button>
        </div>
        <ol class="items-list">
          {{#each items.powers as |power|}}
          <li class="item power" data-item-id="{{power._id}}">
            <div class="item-name">
              <img src="{{power.img}}" title="{{power.name}}" width="24" height="24"/>
              <h4>{{power.name}}</h4>
              <span class="item-level">L{{power.system.level}}</span>
            </div>
            <div class="item-tree">{{power.system.tree}}</div>
            <div class="item-type">{{power.system.powerType}}</div>
            <div class="item-controls">
              <button type="button" class="power-use" data-item-id="{{power._id}}" title="Use Power">
                <i class="fas fa-bolt"></i>
              </button>
              <a class="item-edit" title="Edit Power"><i class="fas fa-edit"></i></a>
              <a class="item-delete" title="Delete Power"><i class="fas fa-trash"></i></a>
            </div>
          </li>
          {{/each}}
        </ol>

        <div class="schticks-header">
          <h3>Schticks</h3>
          <button type="button" class="item-create" data-type="schtick"><i class="fas fa-plus"></i> Add Schtick</button>
        </div>
        <ol class="items-list">
          {{#each items.schticks as |schtick|}}
          <li class="item schtick" data-item-id="{{schtick._id}}">
            <div class="item-name">
              <h4>{{schtick.name}}</h4>
              <span class="item-rank">M{{schtick.system.masteryRank}}</span>
            </div>
            <div class="item-description">{{schtick.system.manifestation}}</div>
            <div class="item-controls">
              <a class="item-edit" title="Edit Schtick"><i class="fas fa-edit"></i></a>
              <a class="item-delete" title="Delete Schtick"><i class="fas fa-trash"></i></a>
            </div>
          </li>
          {{/each}}
        </ol>
      </div>

      {{!-- Echo Tab --}}
      <div class="tab echo" data-group="primary" data-tab="echo">
        <div class="echo-content">
          <div class="form-group">
            <label>Echo:</label>
            <input type="text" name="system.bio.echo" value="{{system.bio.echo}}" placeholder="Human, Elf, etc."/>
          </div>
          <div class="form-group">
            <label>Concept:</label>
            <input type="text" name="system.bio.concept" value="{{system.bio.concept}}" placeholder="Wandering Swordsman"/>
          </div>
          <div class="form-group">
            <label>Appearance:</label>
            <input type="text" name="system.bio.appearance" value="{{system.bio.appearance}}" placeholder="Physical description"/>
          </div>
          <div class="form-group">
            <label>Notes:</label>
            {{editor system.bio.notes target="system.bio.notes" button=true owner=owner editable=editable}}
          </div>
          <div class="form-group">
            <label>Background:</label>
            {{editor system.notes.background target="system.notes.background" button=true owner=owner editable=editable}}
          </div>
          <div class="form-group">
            <label>Schticks:</label>
            <textarea name="system.notes.schticks">{{system.notes.schticks}}</textarea>
          </div>
          <div class="form-group">
            <label>Faith Fractures:</label>
            <textarea name="system.notes.faithFractures">{{system.notes.faithFractures}}</textarea>
          </div>
        </div>
      </div>

      {{!-- Equipment Tab --}}
      <div class="tab equipment" data-group="primary" data-tab="equipment">
        <div class="artifacts-header">
          <h3>Artifacts</h3>
          <button type="button" class="item-create" data-type="artifact"><i class="fas fa-plus"></i> Add Artifact</button>
        </div>
        <ol class="items-list">
          {{#each items.artifacts as |artifact|}}
          <li class="item artifact" data-item-id="{{artifact._id}}">
            <div class="item-name">
              <img src="{{artifact.img}}" title="{{artifact.name}}" width="24" height="24"/>
              <h4>{{artifact.name}}</h4>
              <span class="item-level">L{{artifact.system.level}}</span>
            </div>
            <div class="item-equipped">
              <input type="checkbox" name="items.{{artifact._id}}.system.equipped" {{#if artifact.system.equipped}}checked{{/if}}/>
            </div>
            <div class="item-controls">
              <a class="item-edit" title="Edit Artifact"><i class="fas fa-edit"></i></a>
              <a class="item-delete" title="Delete Artifact"><i class="fas fa-trash"></i></a>
            </div>
          </li>
          {{/each}}
        </ol>

        <div class="weapons-header">
          <h3>Weapons</h3>
          <button type="button" class="item-create" data-type="weapon"><i class="fas fa-plus"></i> Add Weapon</button>
        </div>
        <ol class="items-list">
          {{#each items.weapons as |weapon|}}
          <li class="item weapon" data-item-id="{{weapon._id}}">
            <div class="item-name">
              <h4>{{weapon.name}}</h4>
            </div>
            <div class="item-damage">{{weapon.system.damage}}</div>
            <div class="item-controls">
              <a class="item-edit" title="Edit Weapon"><i class="fas fa-edit"></i></a>
              <a class="item-delete" title="Delete Weapon"><i class="fas fa-trash"></i></a>
            </div>
          </li>
          {{/each}}
        </ol>
      </div>

    </section>

  {{!-- Sheet Tabs (Right Side - Bookmark Style) --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="attributes">Attributes</a>
    <a class="item" data-tab="skills">Skills</a>
    <a class="item" data-tab="powers">Powers</a>
    <a class="item" data-tab="echo">Echo</a>
    <a class="item" data-tab="equipment">Equipment</a>
  </nav>
</form>
